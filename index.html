<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento EFSC - 1936</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <h1>Estrada de Ferro Santa Catharina</h1>
    <h2>Horário dos Trens (1936)</h2>

    <div class="clock-display" id="clock">--:--:--</div>
    <div class="status-panel" id="status-msg">Carregando dados...</div>

    <div class="legend">
        <div><span class="dot" style="background: var(--train-asc)"></span>Ascendente (Blumenau -> Interior)</div>
        <div><span class="dot" style="background: var(--train-desc)"></span>Descendente (Interior -> Blumenau)</div>
    </div>

    <div class="railway-container" id="main-line-container">
        <div class="line-title">Linha Principal (Blumenau - Barra do Trombudo)</div>
        <div class="track-line"></div>
    </div>

    <div class="railway-container" id="branch-line-container">
        <div class="line-title">Ramal (Subida - Hammonia)</div>
        <div class="track-line"></div>
    </div>

    <script>
        // --- DADOS DA TABELA (Baseado na imagem) ---

        // Distância total da linha principal: 104.3 km
        const MAIN_LINE_LENGTH = 104.3;

        // Estações da Linha Principal (Nome e Km)
        const mainStations = [
            { name: "Blumenau", km: 0.0 },
            { name: "Itoupava Secca", km: 2.9 },
            { name: "Salto Weissbach", km: 8.7 },
            { name: "Encano", km: 16.9 },
            { name: "Indayal", km: 22.0 },
            { name: "Warnow", km: 30.7 },
            { name: "Eng. Pedro Gomes", km: 41.5 },
            { name: "Aquidaban", km: 50.1 },
            { name: "Subida", km: 63.1 },
            { name: "Riachuelo", km: 83.4 },
            { name: "Lontras", km: 85.3 },
            { name: "Matador", km: 91.0 },
            { name: "Rio do Sul", km: 97.8 },
            { name: "B. do Trombudo", km: 104.3 }
        ];

        // Ramal: Subida é o Km 0 do ramal para visualização. 
        // Estimando Hammonia a ~12km baseado no tempo de viagem (22min) comparado à linha principal.
        const BRANCH_LINE_LENGTH = 12.0;
        const branchStations = [
            { name: "Subida", km: 0.0 },
            { name: "Hammonia", km: 12.0 }
        ];

        // Dias da semana: 0 = Domingo, 1 = Segunda, ..., 6 = Sábado
        // Tipos de dia na tabela: 
        // "Diario" = [0,1,2,3,4,5,6]
        // "Domingos" = [0]
        // "Diario exceto domingos" = [1,2,3,4,5,6]

        const DAYS_DAILY = [0, 1, 2, 3, 4, 5, 6];
        const DAYS_SUN = [0];
        const DAYS_WEEKDAY = [1, 2, 3, 4, 5, 6];

        // Trens (Horários convertidos para minutos desde meia-noite para facilitar cálculo)
        // Direção 1 = Esquerda->Direita (Ascendente), -1 = Direita->Esquerda (Descendente)
        const trains = [
            // --- LINHA PRINCIPAL ASCENDENTE (Blumenau -> Barra) ---
            { id: "P1", days: DAYS_DAILY, start: "15:00", end: "19:05", dir: 1, line: "main", type: "Passageiro" },
            { id: "P3", days: DAYS_SUN, start: "06:50", end: "10:54", dir: 1, line: "main", type: "Passageiro" },
            { id: "M1", days: DAYS_WEEKDAY, start: "06:20", end: "11:32", dir: 1, line: "main", type: "Misto" },

            // --- LINHA PRINCIPAL DESCENDENTE (Barra -> Blumenau) ---
            { id: "P2", days: DAYS_DAILY, start: "05:02", end: "09:05", dir: -1, line: "main", type: "Passageiro" },
            { id: "P4", days: DAYS_SUN, start: "14:32", end: "18:35", dir: -1, line: "main", type: "Passageiro" },
            { id: "M2", days: DAYS_WEEKDAY, start: "06:06", end: "11:09", dir: -1, line: "main", type: "Misto" },

            // --- RAMAL ASCENDENTE (Subida -> Hammonia) ---
            { id: "PR1", days: DAYS_DAILY, start: "17:22", end: "17:44", dir: 1, line: "branch", type: "Ramal" },
            { id: "PR3", days: DAYS_SUN, start: "09:11", end: "09:33", dir: 1, line: "branch", type: "Ramal" },
            { id: "MR1", days: DAYS_WEEKDAY, start: "09:31", end: "09:57", dir: 1, line: "branch", type: "Misto" },

            // --- RAMAL DESCENDENTE (Hammonia -> Subida) ---
            { id: "PR2", days: DAYS_DAILY, start: "06:20", end: "06:43", dir: -1, line: "branch", type: "Ramal" },
            { id: "PR4", days: DAYS_SUN, start: "15:50", end: "16:13", dir: -1, line: "branch", type: "Ramal" },
            { id: "MR2", days: DAYS_WEEKDAY, start: "07:40", end: "08:06", dir: -1, line: "branch", type: "Misto" }
        ];

        // --- FUNÇÕES AUXILIARES ---

        function timeToMinutes(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        }

        function formatTime(date) {
            return date.toLocaleTimeString('pt-BR', { hour12: false });
        }

        function getDayType(date) {
            const day = date.getDay(); // 0 = Dom, 6 = Sab
            return day;
        }

        function createStationMarkers(containerId, stations, totalLength) {
            const container = document.getElementById(containerId);
            stations.forEach(st => {
                const pct = (st.km / totalLength) * 90; // Usando 90% da largura (5% padding cada lado)

                const dot = document.createElement('div');
                dot.className = 'station';
                dot.style.left = `calc(5% + ${pct}%)`; // Offset inicial de 5%

                const label = document.createElement('div');
                label.className = 'station-label';
                label.innerText = st.name;
                dot.appendChild(label);

                const km = document.createElement('div');
                km.className = 'station-km';
                km.innerText = st.km.toFixed(1);
                dot.appendChild(km);

                container.appendChild(dot);
            });
        }

        function getStationAtKm(km, stations) {
            // Encontra a estação mais próxima (simples aproximação)
            let closest = stations[0];
            let minDiff = Math.abs(km - stations[0].km);

            for (let i = 1; i < stations.length; i++) {
                let diff = Math.abs(km - stations[i].km);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = stations[i];
                }
            }

            // Se estiver muito longe da estação (ex: > 2km), considera "Em trânsito"
            if (minDiff > 2.0) return null;
            return closest.name;
        }

        function getPreviousStation(km, stations, dir) {
            // Retorna a última estação pela qual passou
            let passed = stations.filter(s => dir === 1 ? s.km <= km : s.km >= km);
            if (passed.length === 0) return stations[dir === 1 ? 0 : stations.length - 1].name;

            // Ordena para pegar a mais próxima do KM atual
            passed.sort((a, b) => Math.abs(km - a.km) - Math.abs(km - b.km));
            return passed[0].name;
        }

        // --- LÓGICA PRINCIPAL ---

        function updateSimulation() {
            const now = new Date();
            document.getElementById('clock').innerText = formatTime(now);

            const currentMinutes = now.getHours() * 60 + now.getMinutes() + (now.getSeconds() / 60);
            const currentDay = getDayType(now);

            let activeTrainsCount = 0;
            let msg = `Dia da semana (0=Dom): ${currentDay}. Nenhum trem circulando no momento.`;

            // Limpar trens antigos
            document.querySelectorAll('.train').forEach(e => e.remove());

            trains.forEach(train => {
                // 1. Checa se o trem roda hoje
                if (!train.days.includes(currentDay)) return;

                const startMin = timeToMinutes(train.start);
                const endMin = timeToMinutes(train.end);

                // 2. Checa se está no horário
                if (currentMinutes >= startMin && currentMinutes <= endMin) {
                    activeTrainsCount++;

                    // Calcular progresso (0.0 a 1.0)
                    const totalDuration = endMin - startMin;
                    const elapsed = currentMinutes - startMin;
                    let progress = elapsed / totalDuration; // % da viagem no tempo

                    // Mapear para KM
                    const lineLength = train.line === 'main' ? MAIN_LINE_LENGTH : BRANCH_LINE_LENGTH;
                    let currentKm = 0;

                    if (train.dir === 1) {
                        // Ascendente (0 -> Fim)
                        currentKm = progress * lineLength;
                    } else {
                        // Descendente (Fim -> 0)
                        currentKm = lineLength - (progress * lineLength);
                    }

                    // Determinar onde está visualmente (CSS Left %)
                    // A linha visual começa em 5% e termina em 95% (total 90% width útil)
                    const visualPct = (currentKm / lineLength) * 90;

                    // Criar elemento do trem
                    const trainEl = document.createElement('div');
                    trainEl.className = `train ${train.dir === -1 ? 'desc' : ''}`;
                    trainEl.innerText = train.id;
                    trainEl.style.left = `calc(5% + ${visualPct}%)`;

                    // Informação de Localização
                    const stationsList = train.line === 'main' ? mainStations : branchStations;
                    const nearStation = getStationAtKm(currentKm, stationsList);
                    const prevStation = getPreviousStation(currentKm, stationsList, train.dir);

                    let locText = "";
                    if (nearStation) {
                        locText = `Parado/Passando em ${nearStation}`;
                    } else {
                        locText = `Passou por ${prevStation}`;
                    }

                    trainEl.setAttribute('data-info', `${train.type} ${train.id}: ${locText} (Km ${currentKm.toFixed(1)})`);

                    // Adicionar ao container correto
                    const containerId = train.line === 'main' ? 'main-line-container' : 'branch-line-container';
                    document.getElementById(containerId).appendChild(trainEl);
                }
            });

            if (activeTrainsCount > 0) {
                msg = `${activeTrainsCount} trem(s) em circulação agora.`;
            }

            document.getElementById('status-msg').innerText = msg;
        }

        // --- INICIALIZAÇÃO ---

        createStationMarkers('main-line-container', mainStations, MAIN_LINE_LENGTH);
        createStationMarkers('branch-line-container', branchStations, BRANCH_LINE_LENGTH);

        // Atualiza a cada segundo
        setInterval(updateSimulation, 1000);
        updateSimulation(); // Rodar imediatamente

    </script>
    <div class="train-legend-box">
        <div class="train-group type-p">
            <h3> Trens P (Passageiros)</h3>
            <div class="train-item"><span><strong>P1 e P2</strong></span> <span>Diário</span></div>
            <div class="train-item"><span><strong>P3 e P4</strong></span> <span>Domingos</span></div>
            <p class="train-desc"> Focados em transporte de passageiros, bagagens e pequenas encomendas.</p>
        </div>

        <div class="train-group type-m">
            <h3> Trens M (Mistos)</h3>
            <div class="train-item"><span><strong>M1 e M2</strong></span> <span>Exceto domingos</span></div>
            <div class="train-item"><span><strong>MR1 e MR2</strong></span> <span>Misto Ramal</span></div>
            <p class="train-desc"> Transportam vagões de carga acoplados a carros de passageiros.</p>
        </div>
    </div>
    <section class="about-section">
        <h2>Sobre o Projeto</h2>
        <p>
            Este simulador reproduz o movimento histórico da <strong>Estrada de Ferro Santa Catharina (EFSC)</strong>.
            A lógica de posicionamento é processada em tempo real, baseada nos horários oficiais da publicação de
            <strong>21 de setembro de 1936</strong>.
        </p>
        <p>
            <strong>Elaborado por:</strong> Daniel Baumann
        </p>
        <hr style="border: 0; border-top: 1px solid #ccc; margin: 15px 0;">
        <p style="font-size: 0.85rem; font-style: italic;">
            Fonte documental:
            <a href="http://memoria.bn.gov.br/docreader/882860/2706" target="_blank">
                "Horário dos Trens - EFSC - 1936"
            </a>
            disponível na Hemeroteca Digital Brasileira.
        </p>
    </section>
</body>

</html>